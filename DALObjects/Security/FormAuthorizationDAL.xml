<?xml version="1.0" encoding="utf-8" ?> 

<SQL>
	<GET_FORM_AUTH_BY_USER>
	select distinct TRANSLATIONTABLE.TRANSLATION, TRANSLATIONTABLE.LANGUAGE_ID, U.NETWORK_ID,
		F.CODE, NAV_ALWAYS_ALLOWED, F.RELATIVE_URL,F.FORM_ID
			FROM ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE, ELP_FORM F,ELP_TAB T,
			ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R, ELP_ROLE_AUTH_FORM_INCLUSION RAFI
			WHERE TRANSLATIONTABLE.dict_item_id = F.dict_item_id
			AND U.USER_ID = UR.USER_ID
			AND F.TAB_ID = T.TAB_ID
			AND T.CODE = :CODE
			AND UR.ROLE_ID = RAFI.ROLE_ID
			AND RAFI.FORM_ID = F.FORM_ID
			AND U.NETWORK_ID = :NETWORK_ID
			AND TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
		 	AND RAFI.FORM_ID NOT IN
		 (SELECT ELP_COMPANY_FORM_EXCLUSION.FORM_ID FROM ELP_COMPANY_FORM_EXCLUSION WHERE COMPANY_ID = :COMPANY_ID )
     		ORDER BY TRANSLATIONTABLE.TRANSLATION
	</GET_FORM_AUTH_BY_USER>
	<GET_FORM_AUTH_BY_USER_MULTIPLE_COMPANIES>
	select distinct TRANSLATIONTABLE.TRANSLATION, TRANSLATIONTABLE.LANGUAGE_ID, U.NETWORK_ID,
		F.CODE, NAV_ALWAYS_ALLOWED, F.RELATIVE_URL,F.FORM_ID
			FROM ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE, ELP_FORM F,ELP_TAB T,
			ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R, ELP_ROLE_AUTH_FORM_INCLUSION RAFI
			WHERE TRANSLATIONTABLE.dict_item_id = F.dict_item_id
			AND U.USER_ID = UR.USER_ID
			AND F.TAB_ID = T.TAB_ID
			AND T.CODE = :CODE
			AND UR.ROLE_ID = RAFI.ROLE_ID
			AND RAFI.FORM_ID = F.FORM_ID
			AND U.NETWORK_ID = :NETWORK_ID
			AND TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
		 	AND RAFI.FORM_ID NOT IN
		 (SELECT cf.FORM_ID
		 	FROM ELP_FORM cf,
		 		( Select Count(*) num, f.FORM_ID
	     		from  ELP_COMPANY_FORM_EXCLUSION cfe_int,
	     			  ELP_TAB t,
	     		      ELP_FORM f
	     		Where t.code = :CODE
	     		  and f.tab_id = t.tab_id
	     		  and cfe_int.form_id = f.FORM_ID
	     		  and --dynamic_where_clause
	     		  group by f.form_id
	     		) ce
		 	Where
			ce.num = :NUM_COMPANIES
 	 		and cf.FORM_ID = ce.FORM_ID
		  )
     		ORDER BY TRANSLATIONTABLE.TRANSLATION
	</GET_FORM_AUTH_BY_USER_MULTIPLE_COMPANIES>
  <GET_FORM_AUTH_BY_USER_ALL_TABS>
    select
    distinct TRANSLATIONTABLE.TRANSLATION,
    F.CODE || '|' || F.QUERY_STRING AS Code,
    NAV_ALWAYS_ALLOWED,
    COALESCE(F.RELATIVE_URL,'none') AS RELATIVE_URL,
    DECODE(F.FORM_CATEGORY_ID,null,T.CODE,null) AS PARENT_TAB,
    ELP_FORM_CATEGORY.CODE CATEGORY
    FROM ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE, ELP_FORM F,ELP_TAB T,
    ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R, ELP_ROLE_AUTH_FORM_INCLUSION RAFI,
    ELP_FORM_CATEGORY
    WHERE TRANSLATIONTABLE.dict_item_id = F.dict_item_id
    AND U.USER_ID = UR.USER_ID
    AND F.TAB_ID = T.TAB_ID
    AND T.TAB_ID IN
    ( 	SELECT 	TAB.TAB_ID
    FROM ELP_TAB TAB ,
    ELP_DICT_ITEM_TRANSLATION DIT
    WHERE TAB.DICT_ITEM_ID = DIT.DICT_ITEM_ID(+) AND TAB.TAB_ID NOT IN
    ( Select T.TAB_ID FROM ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R,
    ELP_ROLE_AUTH_TABS_EXCLUSION RATE, ELP_TAB T WHERE(U.USER_ID = UR.USER_ID)
    AND UR.ROLE_ID = R.ROLE_ID
    AND R.ROLE_ID = RATE.ROLE_ID
    AND RATE.TAB_ID = T.TAB_ID
    AND U.NETWORK_ID = :NETWORK_ID
    GROUP BY T.TAB_ID
    HAVING COUNT(*) =
    (SELECT COUNT(*)	FROM ELP_USER U, ELP_USER_ROLE UR
    WHERE(U.USER_ID = UR.USER_ID) AND U.NETWORK_ID = :NETWORK_ID)
    ))
    AND UR.ROLE_ID = RAFI.ROLE_ID
    AND RAFI.FORM_ID = F.FORM_ID
    AND U.NETWORK_ID = :NETWORK_ID
    AND NOT UPPER(F.CODE) = 'HOMEFORM'
    AND TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
    AND ELP_FORM_CATEGORY.FORM_CATEGORY_ID (+) = F.FORM_CATEGORY_ID
    AND RAFI.FORM_ID NOT IN
    (SELECT ELP_COMPANY_FORM_EXCLUSION.FORM_ID FROM ELP_COMPANY_FORM_EXCLUSION WHERE COMPANY_ID = :COMPANY_ID )

    UNION
    SELECT
    distinct TRANSLATIONTABLE.TRANSLATION,
    ELP_FORM_CATEGORY.CODE,
    'N',
    'none',
    T.CODE PARENT_TAB,
    ''
    from ELP_FORM_CATEGORY,
    ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE,
    ELP_FORM, ELP_TAB T
    WHERE TRANSLATIONTABLE.dict_item_id = ELP_FORM_CATEGORY.dict_item_id
    and TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
    and  ELP_FORM_CATEGORY.TAB_ID = T.TAB_ID
    AND T.TAB_ID IN
    ( 	SELECT 	TAB.TAB_ID
    FROM ELP_TAB TAB ,
    ELP_DICT_ITEM_TRANSLATION DIT
    WHERE TAB.DICT_ITEM_ID = DIT.DICT_ITEM_ID(+) AND TAB.TAB_ID NOT IN
    ( Select T.TAB_ID FROM ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R,
    ELP_ROLE_AUTH_TABS_EXCLUSION RATE, ELP_TAB T WHERE(U.USER_ID = UR.USER_ID)
    AND UR.ROLE_ID = R.ROLE_ID
    AND R.ROLE_ID = RATE.ROLE_ID
    AND RATE.TAB_ID = T.TAB_ID
    AND U.NETWORK_ID = :NETWORK_ID
    GROUP BY T.TAB_ID
    HAVING COUNT(*) =
    (SELECT COUNT(*)	FROM ELP_USER U, ELP_USER_ROLE UR
    WHERE(U.USER_ID = UR.USER_ID) AND U.NETWORK_ID = :NETWORK_ID)
    ))
    ORDER BY TRANSLATION ASC
  </GET_FORM_AUTH_BY_USER_ALL_TABS>
  <GET_FORM_AUTH_BY_USER_MULTIPLE_COMPANIES_ALL_TABS>
    select
    distinct TRANSLATIONTABLE.TRANSLATION,
    F.CODE || '|' || F.QUERY_STRING AS Code,
    NAV_ALWAYS_ALLOWED,
    COALESCE(F.RELATIVE_URL,'none') AS RELATIVE_URL,
    DECODE(F.FORM_CATEGORY_ID,null,T.CODE,null) AS PARENT_TAB,
    ELP_FORM_CATEGORY.CODE CATEGORY
    FROM ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE, ELP_FORM F,ELP_TAB T,
    ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R, ELP_ROLE_AUTH_FORM_INCLUSION RAFI,ELP_FORM_CATEGORY
    WHERE TRANSLATIONTABLE.dict_item_id = F.dict_item_id
    AND U.USER_ID = UR.USER_ID
    AND F.TAB_ID = T.TAB_ID
    AND T.TAB_ID IN
    ( 	SELECT 	TAB.TAB_ID
    FROM ELP_TAB TAB ,
    ELP_DICT_ITEM_TRANSLATION DIT
    WHERE TAB.DICT_ITEM_ID = DIT.DICT_ITEM_ID(+) AND TAB.TAB_ID NOT IN
    ( Select T.TAB_ID FROM ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R,
    ELP_ROLE_AUTH_TABS_EXCLUSION RATE, ELP_TAB T WHERE(U.USER_ID = UR.USER_ID)
    AND UR.ROLE_ID = R.ROLE_ID
    AND R.ROLE_ID = RATE.ROLE_ID
    AND RATE.TAB_ID = T.TAB_ID
    AND U.NETWORK_ID = :NETWORK_ID
    GROUP BY T.TAB_ID
    HAVING COUNT(*) =
    (SELECT COUNT(*)	FROM ELP_USER U, ELP_USER_ROLE UR
    WHERE(U.USER_ID = UR.USER_ID) AND U.NETWORK_ID = :NETWORK_ID)
    ) )
    AND UR.ROLE_ID = RAFI.ROLE_ID
    AND NOT UPPER(F.CODE) = 'HOMEFORM'
    AND ELP_FORM_CATEGORY.FORM_CATEGORY_ID (+) = F.FORM_CATEGORY_ID
    AND RAFI.FORM_ID = F.FORM_ID
    AND U.NETWORK_ID = :NETWORK_ID
    AND TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
    AND RAFI.FORM_ID NOT IN
    (SELECT cf.FORM_ID
    FROM ELP_FORM cf,
    ( Select Count(*) num, f.FORM_ID
    from  ELP_COMPANY_FORM_EXCLUSION cfe_int,
    ELP_TAB t,
    ELP_FORM f
    Where f.tab_id = t.tab_id
    and cfe_int.form_id = f.FORM_ID
    and --dynamic_where_clause
    group by f.form_id
    ) ce
    Where
    ce.num = :NUM_COMPANIES
    and cf.FORM_ID = ce.FORM_ID
    )
    UNION
    SELECT
    distinct TRANSLATIONTABLE.TRANSLATION,
    ELP_FORM_CATEGORY.CODE,
    'N',
    'none',
    T.CODE PARENT_TAB,
    ''
    from ELP_FORM_CATEGORY,
    ELP_DICT_ITEM_TRANSLATION TRANSLATIONTABLE,
    ELP_FORM, ELP_TAB T
    WHERE TRANSLATIONTABLE.dict_item_id = ELP_FORM_CATEGORY.dict_item_id
    AND TRANSLATIONTABLE.LANGUAGE_ID = :LANGUAGE_ID
    and  ELP_FORM_CATEGORY.TAB_ID = T.TAB_ID
    AND T.TAB_ID IN
    ( 	SELECT 	TAB.TAB_ID
    FROM ELP_TAB TAB ,
    ELP_DICT_ITEM_TRANSLATION DIT
    WHERE TAB.DICT_ITEM_ID = DIT.DICT_ITEM_ID(+) AND TAB.TAB_ID NOT IN
    ( Select T.TAB_ID FROM ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R,
    ELP_ROLE_AUTH_TABS_EXCLUSION RATE, ELP_TAB T WHERE(U.USER_ID = UR.USER_ID)
    AND UR.ROLE_ID = R.ROLE_ID
    AND R.ROLE_ID = RATE.ROLE_ID
    AND RATE.TAB_ID = T.TAB_ID
    AND U.NETWORK_ID = :NETWORK_ID
    GROUP BY T.TAB_ID
    HAVING COUNT(*) =
    (SELECT COUNT(*)	FROM ELP_USER U, ELP_USER_ROLE UR
    WHERE(U.USER_ID = UR.USER_ID) AND U.NETWORK_ID = :NETWORK_ID)
    ) )

    ORDER BY TRANSLATION ASC
  </GET_FORM_AUTH_BY_USER_MULTIPLE_COMPANIES_ALL_TABS>
  <GET_FORM_NAV> 
		select FORM_ID, CODE, NAV_ALWAYS_ALLOWED from ELITA.ELP_FORM where CODE = :CODE
	</GET_FORM_NAV>
	<GET_FORM_AUTH_BY_SINGLE_FORM>
	select distinct F.RELATIVE_URL,RAFI.PERMISSION_TYPE ,F.FORM_ID
			FROM ELP_FORM F,
			ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE_AUTH_FORM_INCLUSION RAFI
			WHERE U.USER_ID = UR.USER_ID
		  	AND UR.ROLE_ID = RAFI.ROLE_ID
			AND RAFI.FORM_ID = F.FORM_ID
			AND U.NETWORK_ID = :NETWORK_ID
			AND F.CODE = :CODE
		   	AND RAFI.FORM_ID NOT IN
		 (SELECT ELP_COMPANY_FORM_EXCLUSION.FORM_ID FROM ELP_COMPANY_FORM_EXCLUSION WHERE COMPANY_ID = :COMPANY_ID )
	</GET_FORM_AUTH_BY_SINGLE_FORM>
	<GET_FORM_AUTH_BY_SINGLE_FORM_MULTIPLE_COMPANIES>
	select distinct F.RELATIVE_URL,RAFI.PERMISSION_TYPE ,F.FORM_ID
			FROM ELP_FORM F,
			ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE_AUTH_FORM_INCLUSION RAFI
			WHERE U.USER_ID = UR.USER_ID
		  	AND UR.ROLE_ID = RAFI.ROLE_ID
			AND RAFI.FORM_ID = F.FORM_ID
			AND U.NETWORK_ID = :NETWORK_ID
			AND F.CODE = :CODE
		   	AND RAFI.FORM_ID NOT IN
		 (SELECT cf.FORM_ID
		 	FROM ELP_FORM cf,
		 		( Select Count(*) num, f.FORM_ID
	     		from  ELP_COMPANY_FORM_EXCLUSION cfe_int,
	     		      ELP_FORM f
	     		Where f.code = :CODE
	     		  and cfe_int.form_id = f.FORM_ID
	     		  and --dynamic_where_clause
	     		  group by f.form_id
	     		) ce
		 	Where
			ce.num = :NUM_COMPANIES
 	 		and cf.FORM_ID = ce.FORM_ID
		  )
	</GET_FORM_AUTH_BY_SINGLE_FORM_MULTIPLE_COMPANIES>
	<GET_CONTROL_AUTHORIZATION>
    SELECT CONTROL_NAME, DECODE(MAX(PERMTYPE_RANK), 3, 'E', 2, 'V', 1, 'I')PERMISSION_TYPE
    FROM(
    SELECT  fdp.CONTROL_NAME, fdp.ROLE_ID, fdp.FORM_ID, fdp.PERMISSION_TYPE FORM_PERM, cp.PERMISSION_TYPE Control_PERM,
    DECODE( nvl(cp.PERMISSION_TYPE, fdp.PERMISSION_TYPE), 'E', 3, 'V', 2, 'I', 1)PERMTYPE_RANK
    FROM (
    SELECT CONTROL_NAME, ROLE_ID, FORM_ID, PERMISSION_TYPE
    FROM(
    SELECT DISTINCT CONTROL_NAME
    FROM ELP_ROLE_AUTH_CTRL_EXCLUSION ce
    INNER join ELP_FORM f on f.FORM_ID = ce.FORM_ID
    WHERE f.CODE = '#FORM_CODE'
    AND ROLE_ID IN (
    select DISTINCT UR.ROLE_ID
    FROM ELP_USER_ROLE UR
    INNER JOIN ELP_USER U ON U.USER_ID = UR.USER_ID
    INNER JOIN ELP_ROLE_AUTH_FORM_INCLUSION I ON I.ROLE_ID = UR.ROLE_ID
    INNER JOIN ELP_FORM f ON f.FORM_ID = i.FORM_ID
    WHERE U.NETWORK_ID = '#USER_NETWORK_ID' AND f.CODE = '#FORM_CODE')
    ) ctl FULL outer join
    (
    SELECT DISTINCT I.ROLE_ID, I.FORM_ID, PERMISSION_TYPE
    FROM ELP_ROLE_AUTH_FORM_INCLUSION I
    INNER join ELP_FORM f on f.FORM_ID = i.FORM_ID
    WHERE f.CODE = '#FORM_CODE'
    AND I.ROLE_ID IN (
    select DISTINCT ROLE_ID
    FROM ELP_USER_ROLE UR
    INNER JOIN ELP_USER U ON U.USER_ID = UR.USER_ID
    WHERE U.NETWORK_ID =  '#USER_NETWORK_ID')
    )rl on 1=1
    )fdp left outer join ELP_ROLE_AUTH_CTRL_EXCLUSION cp
    on fdp.CONTROL_NAME = cp.CONTROL_NAME and fdp.ROLE_ID = cp.ROLE_ID and fdp.FORM_ID = cp.FORM_ID
    )
    WHERE CONTROL_NAME is not null
    GROUP BY CONTROL_NAME

  </GET_CONTROL_AUTHORIZATION>
	<GET_USER_TAB_AUTH>
			SELECT 	UPPER(DIT.TRANSLATION) AS TRANSLATION, TAB.CODE, DIT.LANGUAGE_ID, 
            DIT.DICT_ITEM_TRANSLATION_ID AS DICT_ITEM_ID,
            TAB.TAB_ICON_IMG, TAB.TAB_ID, TAB.CODE TAB_CODE, '' PARENT_TAB
            FROM ELP_TAB TAB ,
            ELP_DICT_ITEM_TRANSLATION DIT
            WHERE TAB.DICT_ITEM_ID = DIT.DICT_ITEM_ID(+) AND TAB.TAB_ID NOT IN
              ( Select T.TAB_ID FROM ELP_USER U, ELP_USER_ROLE UR, ELP_ROLE R,
                ELP_ROLE_AUTH_TABS_EXCLUSION RATE, ELP_TAB T WHERE(U.USER_ID = UR.USER_ID)
                AND UR.ROLE_ID = R.ROLE_ID
                AND R.ROLE_ID = RATE.ROLE_ID
                AND RATE.TAB_ID = T.TAB_ID
                AND U.NETWORK_ID = :NETWORK_ID1
                GROUP BY T.TAB_ID
                HAVING COUNT(*) =
                  (SELECT COUNT(*)	FROM ELP_USER U, ELP_USER_ROLE UR
                   WHERE(U.USER_ID = UR.USER_ID) AND U.NETWORK_ID = :NETWORK_ID2))
          AND DIT.LANGUAGE_ID = :LANGUAGE_ID
           ORDER BY TAB.TAB_ORDER ASC
    </GET_USER_TAB_AUTH>
</SQL>

